AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy Cybereason Sensor
Parameters:
  AVTagName:
    Default: 'Antivirus'
    Type: String
    Description: Enter the tag name
  AVTagValue:
    Default: 'yes'
    Type: String
    Description: Enter the value
  LoggingWanted:
    Default: 'yes'
    Type: String
    Description: Enter the value
    AllowedValues: [yes, no]
    ConstraintDescription: You must specify "yes" or "no"
Metadata: 
  AWS::CloudFormation::Interface:
    ParameterGroups: 
      - 
        Label: 
          default: "Antivirus"
        Parameters: 
          - AVTagName
          - AVTagValue
        Label: 
          default: "Logging"
        Parameters: 
          - LoggingWanted
    ParameterLabels: 
      AVTagName:
        default: "Name of the tag used to deploy the antivirus"
      AVTagValue:
        default: "Value used to deploy the antivirus"
      LoggingWanted:
        default: "Do you want to log to an S3 bucket?"
Resources:
  CybereasonDocument:
    Type: AWS::SSM::Document
    Properties:
      DocumentType: Command
      Content:
        description: Install Cybereason Sensor
        schemaVersion: '2.2'
        mainSteps:
        - action: aws:runPowerShellScript
          name: installCybereasonSensorWindows
          precondition:
            StringEquals:
            - platformType
            - Windows
          inputs:
            runCommand:
            - !Sub |
                $ErrorActionPreference = "Stop"
                if(-not (Get-WmiObject Win32_Product -Filter "Name='Cybereason Sensor'")){
                  $folder=Join-Path ([System.IO.Path]::GetTempPath()) 'CybereasonInstall'
                  Copy-S3Object -BucketName 'cybereasonsensor' -KeyPrefix '/Windows/' -LocalFolder $folder
                  Start-Process (Join-Path $folder 'CybereasonSensor64_18_1_111_0_tamedia_tamedia-r.cybereason.net_443_ACTIVE_NORMAL_OfflineInstall.exe') -ArgumentList '/install','/norestart','/quiet','-l C:\Windows\Temp\CybereasonInstall.log','AP_APP_CTRL=1','ANTI_MALWARE=1','AP_AV_MODE=3','AP_SA_DETECT_MODE=3','AP_SA_PREVENT_MODE=1','AP_STATE=ACTIVE_NORMAL' -Wait
                  Remove-Item $folder -Force -Recurse
                }
        - action: aws:runShellScript
          name: installCybereasonSensorLinux
          precondition:
            StringEquals:
            - platformType
            - Linux
          inputs:
            runCommand:
            - !Sub |
                #!/bin/bash
                set -e
                if ! rpm -qi cybereason-sensor --quiet; then
                  agentPath='/tmp/cybereasonInstall'
                  aws s3 cp s3://cybereasonsensor/Linux/ $agentPath --recursive
                  rpm -ihv $agentPath/cybereason-sensor-18.1.111.0-1.x86_64_tamedia_tamedia-r.cybereason.net_443_ACTIVE_NORMAL_rpm.rpm
                  rm -rf $agentPath
                fi
  CybereasonDocumentAssociation:
    Type: AWS::SSM::Association
    Properties:
      Name: !Ref CybereasonDocument
      ScheduleExpression: rate(2 hours)
      Targets:
      - Key: !Sub tag:${AVTagName}
        Values: 
        - !Ref AVTagValue